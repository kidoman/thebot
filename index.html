<!DOCTYPE html>
<html>
<head>
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>TheBot - Demo</title>
  <style>
      html, body {
          height: 100%;
      }

      body {
          min-height: 100%;
          margin: 0;
      }

      h1 {
          margin: 3px 0 0 20px;
          font-family: 'Roboto', sans-serif;
          font-weight: bold;
          font-size: 28px;
      }

      #canvas {
          height: 90%;
          margin: 10px;
          border: 1px solid #000;
          border-radius: 10px;
          -moz-border-radius: 10px;
      }

      #hud {
        position: absolute;
        width: 340px;
        height: 310px;
        margin-top: 20px;
        right: 30px;
        text-align: center;

        border: 1px solid;
        border-radius: 20px;
      }

      #snapshot {
        position: relative;
        width: 320px;
        height: 240px;
        margin: 10px 10px 5px 10px;

        border-radius: 20px;
        -moz-border-radius: 20px;

        box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);
        -webkit-box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);

        background-image: -moz-linear-gradient(top, rgba(255, 255, 255, .5), rgba(255, 255, 255, 0) 12px);
        background-image: -webkit-gradient(linear, 0 0, 0 12, from(rgba(255, 255, 255, .5)), to(rgba(255, 255, 255, 0)));
      }

      #speed, #turn {
        display: inline-block;
        font-family: 'Roboto', sans-serif;
        font-size: 27px;
        position: relative;
        border: 1px solid;
        text-align: center;
        width: 50px;
        height: 40px;

        border-radius: 20px;
        -moz-border-radius: 20px;

        box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);
        -webkit-box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);

        background-image: -moz-linear-gradient(top, rgba(255, 255, 255, .5), rgba(255, 255, 255, 0) 12px);
        background-image: -webkit-gradient(linear, 0 0, 0 12, from(rgba(255, 255, 255, .5)), to(rgba(255, 255, 255, 0)));
      }

      #gridx {
          margin-top: 10px;
          background-color: #000;
          position: relative;
          margin: 0 auto;
          width: 1px;
          height: 100%;
          top: 0px;
      }

      #ball {
          background-color: red;
          position: absolute;
          width: 20px;
          height: 20px;
          left: 50%;
          bottom: 40px;
          margin-left: -10px;

          border-radius: 20px;
          -moz-border-radius: 20px;

          box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);
          -moz-box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);
          -webkit-box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);

          background-image: -moz-linear-gradient(top, rgba(255, 255, 255, .5), rgba(255, 255, 255, 0) 12px);
          background-image: -webkit-gradient(linear, 0 0, 0 12, from(rgba(255, 255, 255, .5)), to(rgba(255, 255, 255, 0)));
      }
  </style>
<body>
  <h1>TheBot Demo</h1>
  <div id="canvas">
    <div id="hud">
      <img id="snapshot" />
      <div id="speed">0</div>
      <div id="turn">90</div>
    </div>
    <div id="gridx"></div>
    <div id="ball"></div>
  </div>

  <script>
    var testMode = window.location.search.indexOf('test') > -1
      , canvas = document.getElementById('canvas')
      , canvasWidth = canvas.clientWidth
      , canvasHeight = canvas.clientHeight
      , maxTurn = 45.0
      , turnScale = ((canvasWidth - 60) / 2) / maxTurn
      , minSpeed = 10.0
      , maxSpeed = 50.0
      , maxRealSpeed = 150.0
      , minRealSpeed = 60.0
      , virtRealSpeedScale = (maxRealSpeed - minRealSpeed) / (maxSpeed - minSpeed)
      , speedScale = (canvasHeight - 60) / maxSpeed
      , ball = document.getElementById('ball')
      , $speed = $('#speed')
      , $turn = $('#turn')
      , initialBallY = ball.offsetTop
      , ix = null
      , iy = null
      , amp = 0.0
      , turn = 0.0
      , xf = null
      , yf = null
      , k = 0.6
      , scaledAmp = 0.0
      , scaledTurn = 90.0
      , highColor = '#E80000'
      , mediumColor = '#FF9933'
      , safeColor = '#33CC33'

    function handleOrientationEvent(event) {
      var x = event.beta
        , y = event.gamma

      if (isNaN(x) || isNaN(y))
        return

      if (!ix && !iy) {
        ix = x
        iy = y

        xf = x
        yf = y
      } else {
        xf = k * xf + (1.0 - k) * x
        yf = k * yf + (1.0 - k) * y

        var px = xf - ix
          , py = yf - iy

        amp = px < 0.0 ? -px : 0.0
        if (amp > maxSpeed)
          amp = maxSpeed

        if (Math.abs(py) > maxTurn)
          py = maxTurn

        turn = py
      }
    }

    function represent() {
      ball.style.top = (initialBallY - amp * speedScale) + 'px'
      ball.style.width = (20 + Math.abs(turn) * turnScale) + 'px'

      if (turn < 0.0) {
        ball.style.marginLeft = -(10 + Math.abs(turn) * turnScale) + 'px'
      } else {
        ball.style.marginLeft = '-10px'
      }

      scaledAmp = (amp <= minSpeed) ? 0.0 : (amp - minSpeed) * virtRealSpeedScale + minRealSpeed
      scaledTurn = 90.0 + turn

      $speed.text(amp.toFixed())
      showSafetyHigh($speed, amp, 20, 35)

      $turn.text(scaledTurn.toFixed())
      if (scaledTurn < 90.0)
        showSafetyLow($turn, scaledTurn, 75, 65)
      else
        showSafetyHigh($turn, scaledTurn, 105, 115)
    }

    function showSafetyHigh($reading, reading, medium, high) {
      var color = reading > high ? highColor : (reading > medium) ? mediumColor : safeColor
      $reading.css("background-color", color)
    }

    function showSafetyLow($reading, reading, medium, low) {
      var color = reading > medium ? safeColor : (reading > low) ? mediumColor : highColor
      $reading.css("background-color", color)
    }

    function reset() {
      ix = iy = null
    }

    function sendOrientationToCar() {
      $.post("/turn/" + scaledTurn.toFixed() + "/speed/" + scaledAmp.toFixed())
    }

    function updateSnapshot() {
      $("#snapshot").attr("src", "/snapshot?" + new Date().getTime())
    }

    window.addEventListener("deviceorientation", handleOrientationEvent, true)

    setInterval(represent, 20)

    if (!testMode) {
      setInterval(sendOrientationToCar, 200)
      setInterval(updateSnapshot, 1000)
    }
  </script>
</div>
</body>
</html>
